---
title: 'Visualisasi Rute Lari dengan R dan Leaflet'
author: "Nur Andi Setiabudi"
date: "July 5, 2019"
layout: post
published: yes
share-img: /img/blog/2019/visualisasi-rute-lari-leaflet/strava-map.png
tags:
- r
- leaflet
- strava
- rute
- mapping
- visualisasi
- lari
- running
type: post
excerpt: 
---

Beberapa waktu lalu (tepatnya tiga tahun lalu :D) saya menulis artikel tentang bagaimana [memetakan twit dengan menggunakan Leaflet](https://www.nurandi.id/blog/membuat-peta-dengan-r-dan-leaflet/). Kali ini, saya akan memetakan rute lari yang direkam  perangkat GPS (jam tangan ber-GPS, *smartphone*, dan lain-lain) dengan memamanfaatkan *tools* yang sama, yaitu **R** dan dan *package* **leaflet**. Jika belum familiar dengan Leaflet, ada baiknya membaca [artikel ini](https://rstudio.github.io/leaflet/). *Bocoran* singkatnya, Leaflet adalah salah satu *library* JavaScript paling populer untuk membuat peta interaktif (bukan peta statis). *Package* **leaflet** dikembangkan oleh RStudio untuk memudahkan pembuatan peta melalui R, tanpa harus menulis kode JavaScript. 

# Data yang diperlukan

Tentu saja yang paling utama adalah **data** *tracking*/rute (lari, bersepeda, dan lain-lain) dalam bentuk titik-titik koordinat *(latitide-longitude)*. Data tersebut direkam dengan perangkat atau aplikasi GPS dan biasanya disimpan dalam format GPX *(GPS exchange format),* TCX *(training center XML),* FIT *(flexible and interoperable data transfer),* atau format lainnya. Contoh pada artikel ini akan menggunakan data berformat GPX. File GPX dapat diperoleh dari aplikasi *sport tracking* seperti [Garmin Connect](https://connect.garmin.com), [Endomondo](https://www.endomondo.com/) dan [Strava](https://www.strava.com).

* Garmin Connect (web) : klik **Activities** &#8594; **All Activities** &#8594; pilih salah satu *activity* &#8594; simbol *gear* &#9881; &#8594; **Export to GPX**
* Endomondo (web) : klik **Training** &#8594; **Workouts** atau **History** &#8594; pilih salah satu *workout* &#8594; simbol &#x022C1; &#8594; **Export** &#8594; pilih **GPX Format** &#8594; **Export**
* Strava (web) : klik **Training Log** atau **My Activities** &#8594; pilih salah satu *activity* &#8594; simbol *three dots* &#x022EF; &#8594; **Export GPX** 

Tidak pernah menggunakan aplikasi *tracking* atau tidak punya file GPX? Silakan *download* punya saya di [sini](https://drive.google.com/drive/folders/16d9k_FTsn8Rg5eVGgDbBVWD8vpuvSOKg?usp=sharing).

{% include base_path %}

{% capture fig_img %}
![Strava-map]({{ base_path }}/img/blog/2019/visualisasi-rute-lari-leaflet/strava-map.png)
{% endcapture %}

<figure>
{{ fig_img | markdownify | remove: "<p>" | remove: "</p>" }}
<span class="caption" markdown="1">Peta rute lari pada Strava beserta foto sepanjang rute yang ditampilkan dalam bentuk *pop-up*. [Klik untuk lihat detail.](https://www.strava.com/activities/2474503416)</span>
</figure> 

**Nice to have:** Jika saat lari sempat ambil foto (menggunakan *smartphone* atau kamara digital dengan *location-enabled*), kita bisa memasangnya pada peta dalam bentuk *pop-up* (lihat screen-shot Strava di atas). Ini akan saya bahas pada artikel ini. Silakan ambil foto-fotonya di [sini]((https://drive.google.com/drive/folders/16d9k_FTsn8Rg5eVGgDbBVWD8vpuvSOKg?usp=sharing)) jika menggunakan file GPX saya.  

# Package(s)

Ada tiga *packages* yang akan digunakan, yaitu:

+ **plotKLM** untuk membaca file GPX
+ **exifr** untuk membaca *exif (exchangeable image format) atau metadata dari *image*, dalam hal ini kita akan membaca titik koordinat (latitude-longitude) di mana sebuah foto diambil.
+ **leaflet** untuk membuat peta

Jika *package(s)* tersebut belum terinstal pada R, silakan instal terlebih dahulu dengan perintah

```{r eval=FALSE}
install.packages(c("plotKLM", "exifr", "leaflet"))
```

Khusus **leaflet**, bisa juga instal versi *development*-nya dari [Github](https://github.com/rstudio/leaflet)

```{r eval=FALSE}
if (!require("devtools")) install.packages("devtools")
devtools::install_github("rstudio/leaflet")
```

Setelah itu, *load* semua *package(s)*

```{r}
library(plotKML)
library(exifr)
library(leaflet)
```

# Let's map your running route!

Data sudah tersedia. *Package(s)* yang diperlukan sudah terinstal. Let's map your running route! Ada beberapa tahapan sederhana yang harus dilakukan, yaitu membaca file GPX, membaca *exif* dari foto, dan membuat peta.

## Membaca file GPX untuk mendapatkan titik-titik koordinat dari rute

File GPX dapat dibaca menggunakan fungsi `readGPX` yang tersedia pada *package* **plotKML**. Bisa juga dengan menggunakan *package* **XML** atau **maptools**.

```{r include=FALSE}
route <- readGPX("/Users/widyaningsih/Documents/3_Andi/R/strava-route/Light_Trail_at_Laurel_Creek.gpx")
```

```{r eval=FALSE}
gpx_file <- "Light_Trail_at_Laurel_Creek.gpx"
route <- readGPX(gpx_file)
```

```{r}
str(route)
```

Objek **route** merupakan *list* dengan lima elemen. Yang akan kita gunakan adalah elemen data-frame pada element **tracks**.

```{r}
route <- route$tracks[[1]][[1]]
str(route)
```

Sekarang objek **route** berupa *data-frame* dengan kolom-kolom: *long (longitude)*, *lat (latitude)*, *ele (elevation)*, *time* dan *extensions*.

## Membaca *exif* dari foto untuk mendapatkan titik koordinatnya

*Exif* atau medatada bisa dibaca dengan fungsi `read_exif` pada *package* **exifr**. Saya asumsikan file-file foto berapa pada folder **img** di *working directory*.

```{r eval=FALSE}
picture_files <- list.files("img", full.names = TRUE)

picture_point <- read_exif(picture_files, 
                          tags = c("FileName", "GPSLatitude", "GPSLongitude"), 
                          quiet = TRUE)
```

```{r echo=FALSE}
picture_files <- list.files("/Users/widyaningsih/Documents/3_Andi/R/strava-route/img", full.names = TRUE)

picture_point <- read_exif(picture_files, 
                          tags = c("FileName", "GPSLatitude", "GPSLongitude"), 
                          quiet = TRUE)

picture_point$SourceFile <- gsub("widyaningsih.+\\/", ".../", picture_point$SourceFile)
```

Parameter `tag` berguna untuk memilih *tag* atau informasi apa saja yang akan diambil. Jika ingin mengambil semua informasi yang tersedia, hilangkan parameter tersebut.

```{r}
str(picture_point)
```

Beberapa file tanpa titik koordinat (GPSLatitude dan GPSLongitude `NA`). Untuk memilih **hanya** foto-foto yang memuat informasi koordinat, jalankan perintah berikut:

```{r}
picture_point <- picture_point[!is.na(picture_point$GPSLatitude), ]
str(picture_point)
```










